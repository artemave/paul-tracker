function initMap() {
  var coordinates = []

  <% unless Rails.env.production? %>
    window.testCoordinates = []
  <% end %>

  <% movements.each do |m| %>
    <% unless Rails.env.production? %>
      window.testCoordinates.push([<%= m.lat %>, <%= m.lng %>])
    <% end %>

    coordinates.push( new google.maps.LatLng(<%= m.lat %>, <%= m.lng %>) )
  <% end %>

  if (coordinates.length == 0)
    return

  var mapOptions = { zoomControl: true },
      bounds = new google.maps.LatLngBounds()

  var appMap = new google.maps.Map(document.getElementById('<%= map_container_id %>'), mapOptions)

  var listener = google.maps.event.addListener(appMap, "idle", function () {
      appMap.setOptions({maxZoom: 20});
      google.maps.event.removeListener(listener);
  });

  coordinates.forEach(function(p) {
    bounds.extend(p)
  })

  mapPolyline = new google.maps.Polyline({
    path: coordinates,
    geodesic: true,
    strokeColor: '#FF0000',
    strokeOpacity: 1.0,
    strokeWeight: 2
  });

  appMap.fitBounds(bounds)
  mapPolyline.setMap(appMap);

  $(document).off("ready page:load", initMap)
}

$(document).on("ready page:load", initMap)
