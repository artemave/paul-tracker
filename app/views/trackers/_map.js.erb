var coordinates = []
<% tracker.movements.each do |m| %>
  coordinates.push( new google.maps.LatLng(<%= m.lat %>, <%= m.lng %>) )
<% end %>

function initMap(coordinates) {
  var mapOptions = { zoomControl: true },
      map = new google.maps.Map(document.getElementById('<%= map_container_selector %>'), mapOptions),
      bounds = new google.maps.LatLngBounds()

  coordinates.forEach(function(p) {
    bounds.extend(p)
  })

  var path = new google.maps.Polyline({
    path: coordinates,
    geodesic: true,
    strokeColor: '#FF0000',
    strokeOpacity: 1.0,
    strokeWeight: 2
  });

  map.fitBounds(bounds)
  path.setMap(map);

  var listener = google.maps.event.addListener(map, "idle", function () {
      map.setOptions({maxZoom: 20});
      google.maps.event.removeListener(listener);
  });
}

if (coordinates.length > 0) {
  $(document).on("ready page:load", initMap.bind(null, coordinates))
}
